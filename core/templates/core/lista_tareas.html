{% extends 'base.html' %}
<title>{% block title %}Tareas-Navegatel{% endblock %}</title>
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/lista_tareas.css' %}">
<div class="container">
    <h2>Lista de Tareas</h2>
    <a href="{% url 'crear_tarea' %}" class="btn btn-primary mb-3">Crear Tarea</a>
    
    <form method="GET" class="mb-4">
        <div class="form-group">
            <label for="search">Buscar en tareas:</label>
            <input type="text" class="form-control" id="search" name="search" placeholder="Nombre, Descripción, Proyecto, ...">
        </div>
        <button type="submit" class="btn btn-primary">Buscar</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='{% url 'lista_tareas' %}'">Limpiar</button>
    </form>
    
    <div id="tareas-container" class="tareas-container">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Fin</th>
                    <th>Proyecto</th>
                    <th>Prioridad</th>
                    <th>Estado</th>
                    <th>Cliente</th>
                    <th>Asignado a</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for tarea in page_obj %}
                <tr>
                    <td>{{ tarea.nombre }}</td>
                    <td>{{ tarea.descripcion }}</td>
                    <td>{{ tarea.fecha_inicio }}</td>
                    <td>{{ tarea.fecha_fin }}</td>
                    <td>{{ tarea.proyecto.nombre }}</td>
                    <td>{{ tarea.get_prioridad_display }}</td>
                    <td>{{ tarea.get_estado_display }}</td>
                    <td>{{ tarea.cliente.nombre }}</td>
                    <td>
                        {% if tarea.empleado %}
                            <span class="foto-empleado-container" data-toggle="modal" data-target="#modal-empleados"
                                data-empleados='[{"foto": "{% if tarea.empleado.foto %}{{ tarea.empleado.foto.url }}{% else %}https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSm_dZsN8bn3WWbdZwDETNzxrfISm5YtAklrSYlSunDsg&s{% endif %}", "nombre": "{{ tarea.empleado.first_name }}"}]'>
                                {% if tarea.empleado.foto %}
                                    <img class="foto-empleado empleado-img" src="{{ tarea.empleado.foto.url }}" alt="Foto de perfil" data-id="{{ tarea.empleado.id }}" data-nombre="{{ tarea.empleado.first_name }}">
                                {% else %}
                                    <img class="foto-empleado empleado-img" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSm_dZsN8bn3WWbdZwDETNzxrfISm5YtAklrSYlSunDsg&s" alt="Foto de perfil predeterminada" data-id="{{ tarea.empleado.id }}" data-nombre="{{ tarea.empleado.first_name }}">
                                {% endif %}
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-warning btn-sm">Editar</a>
                        <form action="{% url 'eliminar_tarea' tarea.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Está seguro de que desea eliminar esta tarea?');">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="10">
                        <div class="pagination">
                            {% for num in page_obj.paginator.page_range %}
                                {% if num == page_obj.number %}
                                    <a href="?page={{ num }}" class="active">{{ num }}</a>
                                {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                                    <a href="?page={{ num }}">{{ num }}</a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Modal para empleados -->
<div class="modal fade" id="modal-empleados" tabindex="-1" role="dialog" aria-labelledby="modal-empleados-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-empleados-label">Empleados</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="lista-empleados">
                <!-- Contenido del modal se agregará dinámicamente con JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('.foto-empleado-container').forEach(container => {
        container.addEventListener('click', function() {
            const empleadosData = JSON.parse(container.getAttribute('data-empleados'));
            
            // Actualiza el contenido del modal
            const modalBody = document.getElementById('lista-empleados');
            modalBody.innerHTML = '';  // Limpia el contenido anterior

            empleadosData.forEach(empleado => {
                const empleadoFoto = empleado.foto;
                const empleadoNombre = empleado.nombre;

                // Crea un contenedor para cada imagen con nombre
                const empleadoDiv = document.createElement('div');
                empleadoDiv.classList.add('empleado-item');

                const empleadoImg = document.createElement('img');
                empleadoImg.src = empleadoFoto;
                empleadoImg.alt = `Foto de ${empleadoNombre}`;
                empleadoImg.classList.add('img-fluid', 'empleado-img');

                const empleadoName = document.createElement('div');
                empleadoName.textContent = empleadoNombre;

                empleadoDiv.appendChild(empleadoImg);
                empleadoDiv.appendChild(empleadoName);
                modalBody.appendChild(empleadoDiv);
            });

            // Muestra el modal
            $('#modal-empleados').modal('show');
        });
    });
    
    // Escucha el evento de teclado para la búsqueda
    document.getElementById('search').addEventListener('keyup', function() {
        const searchValue = this.value;
    
        // Realizar una solicitud AJAX al servidor
        fetch(`{% url 'lista_tareas' %}?search=${searchValue}`)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTable = doc.querySelector('.tareas-container').innerHTML;
                document.querySelector('.tareas-container').innerHTML = newTable;
    
                // Reasignar eventos de clic a las nuevas imágenes de empleados
                document.querySelectorAll('.foto-empleado-container').forEach(container => {
                    container.addEventListener('click', function() {
                        const empleadosData = JSON.parse(container.getAttribute('data-empleados'));
                        
                        // Actualiza el contenido del modal
                        const modalBody = document.getElementById('lista-empleados');
                        modalBody.innerHTML = '';  // Limpia el contenido anterior
        
                        empleadosData.forEach(empleado => {
                            const empleadoFoto = empleado.foto;
                            const empleadoNombre = empleado.nombre;
        
                            // Crea un contenedor para cada imagen con nombre
                            const empleadoDiv = document.createElement('div');
                            empleadoDiv.classList.add('empleado-item');
        
                            const empleadoImg = document.createElement('img');
                            empleadoImg.src = empleadoFoto;
                            empleadoImg.alt = `Foto de ${empleadoNombre}`;
                            empleadoImg.classList.add('img-fluid', 'empleado-img');
        
                            const empleadoName = document.createElement('p');
                            empleadoName.textContent = empleadoNombre;
        
                            empleadoDiv.appendChild(empleadoImg);
                            empleadoDiv.appendChild(empleadoName);
                            modalBody.appendChild(empleadoDiv);
                        });
        
                        // Muestra el modal
                        $('#modal-empleados').modal('show');
                    });
                });
            })
            .catch(error => console.error('Error al cargar las tareas:', error));
    });
</script>

{% endblock %}
